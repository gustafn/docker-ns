# SPDX-License-Identifier: MPL-2.0
#
# Base NaviServer installation
#
# Warning: this file was automatically generated. Do not modify it.

FROM alpine:latest


    
ENV LC_ALL=en_US.UTF-8

# The Makefile passes in the following variables
#ARG version_ns=GIT       # passed in via --build-arg "version_ns=..."
#ARG version_tcl=8.6.17   # passed in via --build-arg "version_tcl=..."
#ARG version_tcllib=1.20  # passed in via --build-arg "version_tcllib=..."
#ARG version_xotcl=2.4.0  # passed in via --build-arg "version_xotcl=..."

ARG version_ns
ARG version_tcl
ARG version_tcllib
ARG version_xotcl

ARG with_ns_doc=1
ARG with_system_malloc=1
ARG with_debug_flags=0
ARG version_tdom=0.9.6
ARG ns_modules="nsudp nssmtpd nsstats revproxy nsauthpam"
ARG system_pkgs=""

RUN addgroup --system nsadmin \
    && adduser --disabled-password --no-create-home --ingroup nsadmin --gecos "NaviServer Admin" nsadmin \
    && mkdir -p /scripts

RUN dev_packages="git patch curl wget linux-pam-dev" && apk add --no-cache bash mimalloc $dev_packages $system_pkgs \
    && git clone https://github.com/gustafn/install-ns.git \
    && cd install-ns \
    && with_postgres=0 \
       version_ns=${version_ns} \
       with_ns_doc=${with_ns_doc} \
       with_system_malloc=${with_system_malloc} \
       with_debug_flags=${with_debug_flags} \
       version_tcllib=${version_tcllib} \
       version_xotcl=${version_xotcl} \
       version_tdom=${version_tdom} \
       ns_modules=${ns_modules} \
       bash install-ns.sh build \
    && rm -rf /usr/local/src \
    && apk del curl git musl-dev gcc make zlib-dev libpq-dev openssl-dev autoconf automake m4 patch ncurses bash \
    && rm -rf /usr/local/src

# The following script is necessary, when later extra modules are
# loaded. The used script above "install-ns" does not need it.

COPY get-naviserver-modules.sh /scripts

